  Build_Player_With_Tests_PS4:
    name: Build Players with tests PS4
    agent:
        # Do not choose machines with gpus or connected devices to perform this step
        # If it takes a lot of time to compile your project prefer flavor with more cores.
        # see https://internaldocs.hq.unity3d.com/bokken/reference/flavors/
        type: Unity::VM
        image: playstation/ps4-buildandexecute:stable
        flavor: b1.xlarge
    variables:
      SCE_ORBIS_SDK_DIR: "C:/Users/bokken/SCE/ps4_sdk_8_00/"
      UNITY_BRANCH: trunk
    commands:
      - gsudo choco install unity-downloader-cli -y -s https://artifactory.prd.it.unity3d.com/artifactory/api/nuget/unity-choco-local
      - unity-downloader-cli -c Editor -c ps4 -u %UNITY_BRANCH% --wait
      - curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr.bat --output utr.bat
      - ./utr --suite=playmode --platform=ps4 --editor-location=.Editor --testproject=. --player-save-path=build/players --artifacts_path=build/logs --build-only
    artifacts:
      players:
          paths:
            - "build/players/**"
      logs:
          paths:
            - "build/logs/**"
  
  Run_Player_With_Tests_PS4:
    name: Run Test on a PS4 player
    # no need to clone repo
    skip_checkout: true
    agent:
        # Running tests is fast, building it not requried, therefore flavor can be smaller. see https://internaldocs.hq.unity3d.com/bokken/reference/flavors/
        # Now we can use an 'expensive' type. 
        type: Unity::console::ps4
        image: playstation/ps4-buildandexecute:stable
        flavor: b1.large
    variables:
      SCE_ORBIS_SDK_DIR: "C:/Users/bokken/SCE/ps4_sdk_8_00/"
      UNITY_BRANCH: trunk
    dependencies:
      - path: .yamato/ps4.yml#Build_Player_With_Tests_PS4
        rerun: always
    commands:
      - gsudo NetSh Advfirewall set allprofiles state off
      - orbis-ctrl add %BOKKEN_DEVICE_IP%
      - curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr.bat --output utr.bat
      - ./utr --suite=playmode --platform=ps4 --player-load-path=build/players --artifacts_path=build/test-results --player-connection-ip=%BOKKEN_HOST_IP%
    artifacts:
      logs:
          paths:
            - "build/test-results/**"
