Build_Player_With_Tests_XBoxOne:
  name: Build Players with tests XBoxOne
  variables:
    UNITY_BRANCH: trunk
    # note, that xboxone only works on 2020.3 & 2019.4
    VERSION: "2020.3"
  agent:
      # Do not choose machines with gpus or connected devices to perform this step
      # If it takes a lot of time to compile your project prefer flavor with more cores.
      # see https://internaldocs.hq.unity3d.com/bokken/reference/flavors/
      type: Unity::VM
      image: gamecore/gamecore-xdk-ci:v2.1.2
      flavor: b1.xlarge
  commands:
    - choco upgrade unity-downloader-cli -y -s https://artifactory.prd.it.unity3d.com/artifactory/api/nuget/unity-choco-local
    - unity-downloader-cli -c Editor -c GameCoreXboxOne -u %UNITY_BRANCH% --wait
    - curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr.bat --output utr.bat
    - ./utr --suite=playmode --platform=GameCoreXboxOne --editor-location=.Editor --testproject=. --player-save-path=build/players --artifacts_path=build/logs --build-only
  artifacts:
    players:
        paths:
          - "build/players/**"
    logs:
        paths:
          - "build/logs/**"

Run_Player_With_Tests_XBoxOne:
  name: Run Test on an xboxone built player
  variables:
    UNITY_BRANCH: trunk
    # no need to clone repo
  skip_checkout: true
  agent:
      # Running tests is fast, building it not requried, therefore flavor can be smaller. see https://internaldocs.hq.unity3d.com/bokken/reference/flavors/
      # Now we can use an 'expensive' type. 
      type: Unity::console::xbox
      image: gamecore/gamecore-xdk-ci:v2.1.2
      flavor: b1.large
  dependencies:
    - .yamato/xbox.yml#Build_Player_With_Tests_XBoxOne
  commands:
    - NetSh Advfirewall set allprofiles state off
    - '"%GameDK%/bin/xbconnect" /WS %BOKKEN_DEVICE_IP%'
    - curl -s https://artifactory.prd.it.unity3d.com/artifactory/unity-tools-local/utr-standalone/utr.bat --output utr.bat
    - ./utr --suite=playmode --platform=GameCoreXboxOne --player-load-path=build/players --artifacts_path=build/test-results --player-connection-ip=%BOKKEN_HOST_IP% --device-ip=%BOKKEN_DEVICE_IP%
  artifacts:
    logs:
        paths:
          - "build/test-results/**"
